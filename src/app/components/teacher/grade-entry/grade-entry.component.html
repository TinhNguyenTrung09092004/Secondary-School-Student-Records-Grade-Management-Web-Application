<div class="grade-container">
  <div class="page-header">
    <h2>Nh·∫≠p ƒêi·ªÉm H·ªçc Sinh</h2>
  </div>

  <div class="toolbar">
    <button (click)="toggleCommentMode()" class="btn btn-primary">
      {{ isCommentMode ? 'Chuy·ªÉn sang ƒêi·ªÉm S·ªë (10)' : 'Chuy·ªÉn sang Nh·∫≠n X√©t (Pass/Fail)' }}
    </button>
    <button (click)="openImportDialog()" class="btn btn-success">
      üì• Import t·ª´ Excel
    </button>
    <button (click)="openExportDialog()" class="btn btn-warning">
      üì§ Export
    </button>
    <span class="mode-indicator">
      Ch·∫ø ƒë·ªô hi·ªán t·∫°i: {{ isCommentMode ? 'Nh·∫≠n X√©t (Pass/Fail)' : 'ƒêi·ªÉm S·ªë (10)' }}
    </span>
  </div>

  <p *ngIf="errorMessage" class="message error-message">{{ errorMessage }}</p>
  <p *ngIf="successMessage" class="message success-message">{{ successMessage }}</p>
  <p *ngIf="loading" class="message loading-message">ƒêang t·∫£i...</p>

  <!-- Selection filters -->
  <div class="filter-section">
    <div class="form-group">
      <label class="form-label">L·ªõp - M√¥n h·ªçc:</label>
      <select (change)="onClassChange($event)" class="form-select">
        <option value="">-- Ch·ªçn l·ªõp v√† m√¥n h·ªçc --</option>
        <option *ngFor="let cls of teacherClasses" [value]="getClassSubjectKey(cls)">
          {{ cls.className }} - {{ cls.subjectName }} ({{ cls.schoolYearName }})
        </option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">H·ªçc k·ª≥:</label>
      <select (change)="onSemesterChange($event)" class="form-select">
        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
        <option *ngFor="let semester of semesters" [value]="semester.semesterId">
          {{ semester.semesterName }}
        </option>
      </select>
    </div>
  </div>

  <!-- Search box -->
  <div *ngIf="selectedClass && selectedSemester && studentGrades.length > 0" class="search-section">
    <div class="search-wrapper">
      <label class="form-label">T√¨m ki·∫øm:</label>
      <div class="search-input-wrapper">
        <input type="text"
               [(ngModel)]="searchQuery"
               (input)="onSearchChange()"
               placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ h·ªçc sinh..."
               class="search-input">
        <button *ngIf="searchQuery"
                (click)="clearSearch()"
                class="clear-btn"
                title="X√≥a t√¨m ki·∫øm">
          √ó
        </button>
      </div>
      <span *ngIf="searchQuery" class="search-result">
        T√¨m th·∫•y: {{ filteredStudents.length }} / {{ studentGrades.length }}
      </span>
    </div>
  </div>

  <!-- Grade entry table -->
  <div *ngIf="selectedClass && selectedSemester && studentGrades.length > 0" class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>STT</th>
          <th>H·ªç v√† T√™n</th>
          <th *ngFor="let gradeType of gradeTypes">
            {{ gradeType.gradeTypeName }}<br>
            <small>(H·ªá s·ªë {{ gradeType.coefficient }})</small>
          </th>
          <th class="average-column">
            ƒêi·ªÉm Trung B√¨nh
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let student of paginatedStudents; let i = index">
          <td>{{ startIndex + i + 1 }}</td>
          <td>{{ student.studentName }}</td>
          <td *ngFor="let gradeType of gradeTypes">
            <!-- Edit mode -->
            <div *ngIf="isEditing(student.studentId, gradeType.gradeTypeId); else displayMode" class="edit-controls">
              <!-- Score input mode -->
              <input *ngIf="!isCommentMode"
                     type="number"
                     [(ngModel)]="tempScore"
                     min="0"
                     max="10"
                     step="0.25"
                     class="grade-input"
                     (keyup.enter)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                     (keyup.escape)="cancelEdit()">
              <!-- Comment select mode -->
              <select *ngIf="isCommentMode"
                      [(ngModel)]="tempScore"
                      class="grade-select"
                      (keyup.enter)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                      (keyup.escape)="cancelEdit()">
                <option value="">-- Ch·ªçn --</option>
                <option value="Pass">Pass</option>
                <option value="Fail">Fail</option>
              </select>
              <div class="button-group">
                <button (click)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                        class="btn btn-success btn-small">
                  L∆∞u
                </button>
                <button (click)="cancelEdit()"
                        class="btn btn-secondary btn-small">
                  H·ªßy
                </button>
              </div>
            </div>

            <!-- Display mode -->
            <ng-template #displayMode>
              <ng-container *ngIf="getGradeForStudent(student, gradeType.gradeTypeId) as grade; else noGrade">
                <!-- Display comment if in comment mode -->
                <span *ngIf="grade.isComment && grade.comment"
                      class="grade-display"
                      [style.color]="grade.comment === 'Pass' ? '#2ecc71' : '#e74c3c'"
                      [style.font-weight]="'bold'"
                      (click)="startEdit(student.studentId, gradeType.gradeTypeId, grade.score, grade.comment)">
                  {{ grade.comment }}
                </span>
                <!-- Display score if in score mode -->
                <span *ngIf="!grade.isComment && grade.score !== null"
                      class="grade-display"
                      (click)="startEdit(student.studentId, gradeType.gradeTypeId, grade.score, grade.comment)">
                  {{ grade.score }}
                </span>
                <!-- Show input button if no data -->
                <button *ngIf="!grade.isComment && grade.score === null && !grade.comment"
                        (click)="startEdit(student.studentId, gradeType.gradeTypeId, null)"
                        class="btn-enter">
                  Nh·∫≠p ƒëi·ªÉm
                </button>
                <!-- Delete button -->
                <button *ngIf="(grade.score !== null || grade.comment)"
                        (click)="deleteGrade(grade)"
                        class="btn-delete"
                        title="X√≥a ƒëi·ªÉm">
                  √ó
                </button>
              </ng-container>
              <ng-template #noGrade>
                <button (click)="startEdit(student.studentId, gradeType.gradeTypeId, null)"
                        class="btn-enter">
                  Nh·∫≠p ƒëi·ªÉm
                </button>
              </ng-template>
            </ng-template>
          </td>
          <!-- Average column -->
          <td class="average-column"
              [style.color]="calculateAverage(student) === 'Fail' ? '#e74c3c' : (calculateAverage(student) === 'Pass' ? '#2ecc71' : '#2c3e50')">
            {{ calculateAverage(student) }}
          </td>
        </tr>
      </tbody>
    </table>

  </div>

  <!-- Pagination Controls -->
  <div class="pagination">
    <div class="pagination-info">
      <label class="form-label">S·ªë d√≤ng m·ªói trang:</label>
      <select (change)="onPageSizeChange($event)" [value]="pageSize" class="page-size-select">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
      <span class="search-result">
        Hi·ªÉn th·ªã {{ startIndex + 1 }} - {{ endIndex }} c·ªßa {{ filteredStudents.length }} h·ªçc sinh
        <span *ngIf="searchQuery">({{ studentGrades.length }} t·ªïng s·ªë)</span>
      </span>
    </div>

    <div class="pagination-controls">
      <button (click)="previousPage()"
              [disabled]="currentPage === 1"
              class="page-btn">
        ‚Äπ Tr∆∞·ªõc
      </button>

      <button *ngFor="let page of getPageNumbers()"
              (click)="goToPage(page)"
              [class.active]="page === currentPage"
              class="page-btn">
        {{ page }}
      </button>

      <button (click)="nextPage()"
              [disabled]="currentPage === totalPages"
              class="page-btn">
        Sau ‚Ä∫
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="selectedClass && selectedSemester && studentGrades.length === 0 && !loading" class="empty-state">
    <p>Kh√¥ng c√≥ h·ªçc sinh n√†o trong l·ªõp n√†y.</p>
  </div>

  <div *ngIf="selectedClass && selectedSemester && gradeTypes.length === 0 && !loading" class="warning-state">
    <p><strong>Ch∆∞a c√≥ lo·∫°i ƒëi·ªÉm n√†o trong h·ªá th·ªëng!</strong></p>
    <p>Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ th√™m c√°c lo·∫°i ƒëi·ªÉm (Th∆∞·ªùng xuy√™n, Gi·ªØa k·ª≥, Cu·ªëi k·ª≥, v.v.)</p>
  </div>

  <div *ngIf="!selectedClass || !selectedSemester" class="empty-state">
    <p>Vui l√≤ng ch·ªçn l·ªõp, m√¥n h·ªçc v√† h·ªçc k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠p ƒëi·ªÉm.</p>
  </div>

  <!-- Import Dialog -->
  <div *ngIf="showImportDialog" class="modal-overlay" (click)="closeImportDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Import ƒêi·ªÉm t·ª´ Excel</h3>
      </div>

      <div class="modal-section">
        <label class="form-label">Lo·∫°i ƒëi·ªÉm:</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio"
                   [(ngModel)]="importScoreType"
                   value="score"
                   name="scoreType">
            ƒêi·ªÉm s·ªë (0-10)
          </label>
          <label class="radio-label">
            <input type="radio"
                   [(ngModel)]="importScoreType"
                   value="comment"
                   name="scoreType">
            Nh·∫≠n x√©t (Pass/Fail)
          </label>
        </div>
      </div>

      <div class="modal-section">
        <label class="form-label">Ch·ªçn file Excel:</label>
        <input type="file"
               accept=".xlsx,.xls"
               (change)="onFileSelected($event)"
               class="file-input">
        <small class="file-hint">
          File Excel ph·∫£i c√≥ c·ªôt: M√£ HS, Lo·∫°i ƒêi·ªÉm (ID), ƒêi·ªÉm/Nh·∫≠n x√©t
        </small>
      </div>

      <div class="modal-actions">
        <button (click)="closeImportDialog()" class="btn btn-secondary">
          H·ªßy
        </button>
        <button (click)="importGrades()"
                [disabled]="!importFile"
                class="btn btn-success">
          Import
        </button>
      </div>
    </div>
  </div>

  <!-- Export Dialog -->
  <div *ngIf="showExportDialog" class="modal-overlay" (click)="closeExportDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Export B·∫£ng ƒêi·ªÉm</h3>
      </div>

      <div class="modal-section">
        <label class="form-label">Ch·ªçn ƒë·ªãnh d·∫°ng file:</label>
        <div class="export-options">
          <label class="export-option">
            <input type="radio"
                   [(ngModel)]="exportFormat"
                   value="excel"
                   name="exportFormat">
            <span class="option-icon">üìä</span>
            <span>Excel (.xlsx)</span>
          </label>
          <label class="export-option">
            <input type="radio"
                   [(ngModel)]="exportFormat"
                   value="word"
                   name="exportFormat">
            <span class="option-icon">üìÑ</span>
            <span>Word (.docx)</span>
          </label>
          <label class="export-option">
            <input type="radio"
                   [(ngModel)]="exportFormat"
                   value="pdf"
                   name="exportFormat">
            <span class="option-icon">üìï</span>
            <span>PDF (.pdf)</span>
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="closeExportDialog()" class="btn btn-secondary">
          H·ªßy
        </button>
        <button (click)="exportGrades()"
                [disabled]="!exportFormat"
                class="btn btn-warning">
          Export
        </button>
      </div>
    </div>
  </div>
</div>
