<h2>Nh·∫≠p ƒêi·ªÉm H·ªçc Sinh</h2>

<div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
  <button (click)="toggleCommentMode()"
          style="padding: 8px 16px; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px;">
    {{ isCommentMode ? 'Chuy·ªÉn sang ƒêi·ªÉm S·ªë (10)' : 'Chuy·ªÉn sang Nh·∫≠n X√©t (Pass/Fail)' }}
  </button>
  <button (click)="openImportDialog()"
          style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px;">
    üì• Import t·ª´ Excel
  </button>
  <button (click)="openExportDialog()"
          style="padding: 8px 16px; background-color: #FF9800; color: white; border: none; cursor: pointer; border-radius: 4px;">
    üì§ Export
  </button>
  <span style="font-weight: bold;">
    Ch·∫ø ƒë·ªô hi·ªán t·∫°i: {{ isCommentMode ? 'Nh·∫≠n X√©t (Pass/Fail)' : 'ƒêi·ªÉm S·ªë (10)' }}
  </span>
</div>

<p *ngIf="errorMessage" style="color: red;">{{ errorMessage }}</p>
<p *ngIf="successMessage" style="color: green;">{{ successMessage }}</p>
<p *ngIf="loading">ƒêang t·∫£i...</p>

<!-- Selection filters -->
<div style="margin-bottom: 20px;">
  <div style="margin-bottom: 10px;">
    <label>L·ªõp - M√¥n h·ªçc:</label><br>
    <select (change)="onClassChange($event)" style="width: 400px; padding: 5px;">
      <option value="">-- Ch·ªçn l·ªõp v√† m√¥n h·ªçc --</option>
      <option *ngFor="let cls of teacherClasses" [value]="getClassSubjectKey(cls)">
        {{ cls.className }} - {{ cls.subjectName }} ({{ cls.schoolYearName }})
      </option>
    </select>
  </div>

  <div style="margin-bottom: 10px;">
    <label>H·ªçc k·ª≥:</label><br>
    <select (change)="onSemesterChange($event)" style="width: 400px; padding: 5px;">
      <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
      <option *ngFor="let semester of semesters" [value]="semester.semesterId">
        {{ semester.semesterName }}
      </option>
    </select>
  </div>
</div>

<!-- Search box -->
<div *ngIf="selectedClass && selectedSemester && studentGrades.length > 0" style="margin-bottom: 15px;">
  <div style="display: flex; align-items: center; gap: 10px; max-width: 500px;">
    <label style="font-weight: bold; white-space: nowrap;">T√¨m ki·∫øm:</label>
    <div style="position: relative; flex: 1;">
      <input type="text"
             [(ngModel)]="searchQuery"
             (input)="onSearchChange()"
             placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ h·ªçc sinh..."
             style="width: 100%; padding: 8px 35px 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      <button *ngIf="searchQuery"
              (click)="clearSearch()"
              style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999; font-size: 18px; padding: 5px;"
              title="X√≥a t√¨m ki·∫øm">
        √ó
      </button>
    </div>
    <span *ngIf="searchQuery" style="color: #666; font-size: 14px;">
      T√¨m th·∫•y: {{ filteredStudents.length }} / {{ studentGrades.length }}
    </span>
  </div>
</div>

<!-- Grade entry table -->
<div *ngIf="selectedClass && selectedSemester && studentGrades.length > 0" style="overflow-x: auto;">
  <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
    <thead>
      <tr style="background-color: #f0f0f0;">
        <th style="padding: 10px; text-align: left; min-width: 50px;">STT</th>
        <th style="padding: 10px; text-align: left; min-width: 150px;">H·ªç v√† T√™n</th>
        <th *ngFor="let gradeType of gradeTypes"
            style="padding: 10px; text-align: center; min-width: 100px;">
          {{ gradeType.gradeTypeName }}<br>
          <small>(H·ªá s·ªë {{ gradeType.coefficient }})</small>
        </th>
        <th style="padding: 10px; text-align: center; min-width: 100px; background-color: #e8f5e9;">
          ƒêi·ªÉm Trung B√¨nh
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let student of paginatedStudents; let i = index">
        <td style="padding: 10px; text-align: center;">{{ startIndex + i + 1 }}</td>
        <td style="padding: 10px;">{{ student.studentName }}</td>
        <td *ngFor="let gradeType of gradeTypes"
            style="padding: 5px; text-align: center; position: relative;">
          <!-- Edit mode (shown regardless of whether grade exists) -->
          <div *ngIf="isEditing(student.studentId, gradeType.gradeTypeId); else displayMode" style="display: flex; flex-direction: column; gap: 5px;">
            <!-- Score input mode -->
            <input *ngIf="!isCommentMode"
                   type="number"
                   [(ngModel)]="tempScore"
                   min="0"
                   max="10"
                   step="0.25"
                   style="width: 60px; padding: 5px; margin: 0 auto;"
                   (keyup.enter)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                   (keyup.escape)="cancelEdit()">
            <!-- Comment select mode -->
            <select *ngIf="isCommentMode"
                    [(ngModel)]="tempScore"
                    style="width: 80px; padding: 5px; margin: 0 auto;"
                    (keyup.enter)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                    (keyup.escape)="cancelEdit()">
              <option value="">-- Ch·ªçn --</option>
              <option value="Pass">Pass</option>
              <option value="Fail">Fail</option>
            </select>
            <div style="display: flex; gap: 5px; justify-content: center;">
              <button (click)="saveGrade(student, getGradeForStudent(student, gradeType.gradeTypeId))"
                      style="padding: 3px 8px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">
                L∆∞u
              </button>
              <button (click)="cancelEdit()"
                      style="padding: 3px 8px; background-color: #999; color: white; border: none; cursor: pointer;">
                H·ªßy
              </button>
            </div>
          </div>

          <!-- Display mode -->
          <ng-template #displayMode>
            <ng-container *ngIf="getGradeForStudent(student, gradeType.gradeTypeId) as grade; else noGrade">
              <!-- Display comment if in comment mode -->
              <span *ngIf="grade.isComment && grade.comment"
                    style="cursor: pointer; display: block; padding: 5px;"
                    [style.color]="grade.comment === 'Pass' ? 'green' : 'red'"
                    [style.font-weight]="'bold'"
                    (click)="startEdit(student.studentId, gradeType.gradeTypeId, grade.score, grade.comment)">
                {{ grade.comment }}
              </span>
              <!-- Display score if in score mode -->
              <span *ngIf="!grade.isComment && grade.score !== null"
                    style="cursor: pointer; display: block; padding: 5px;"
                    (click)="startEdit(student.studentId, gradeType.gradeTypeId, grade.score, grade.comment)">
                {{ grade.score }}
              </span>
              <!-- Show input button if no data -->
              <button *ngIf="!grade.isComment && grade.score === null && !grade.comment"
                      (click)="startEdit(student.studentId, gradeType.gradeTypeId, null)"
                      style="padding: 5px 10px; cursor: pointer;">
                Nh·∫≠p ƒëi·ªÉm
              </button>
              <!-- Delete button (show only if there's data) -->
              <button *ngIf="(grade.score !== null || grade.comment)"
                      (click)="deleteGrade(grade)"
                      style="margin-top: 5px; padding: 3px 8px; background-color: #f44336; color: white; border: none; cursor: pointer;"
                      title="X√≥a ƒëi·ªÉm">
                √ó
              </button>
            </ng-container>
            <ng-template #noGrade>
              <button (click)="startEdit(student.studentId, gradeType.gradeTypeId, null)"
                      style="padding: 5px 10px; cursor: pointer;">
                Nh·∫≠p ƒëi·ªÉm
              </button>
            </ng-template>
          </ng-template>
        </td>
        <!-- Average column -->
        <td style="padding: 10px; text-align: center; background-color: #f1f8e9; font-weight: bold;"
            [style.color]="calculateAverage(student) === 'Fail' ? 'red' : (calculateAverage(student) === 'Pass' ? 'green' : '#333')">
          {{ calculateAverage(student) }}
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Pagination Controls -->
  <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <label>S·ªë d√≤ng m·ªói trang:</label>
      <select (change)="onPageSizeChange($event)" [value]="pageSize" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
      <span style="color: #666;">
        Hi·ªÉn th·ªã {{ startIndex + 1 }} - {{ endIndex }} c·ªßa {{ filteredStudents.length }} h·ªçc sinh
        <span *ngIf="searchQuery">({{ studentGrades.length }} t·ªïng s·ªë)</span>
      </span>
    </div>

    <div style="display: flex; gap: 5px; align-items: center;">
      <button (click)="previousPage()"
              [disabled]="currentPage === 1"
              style="padding: 8px 12px; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px;"
              [style.opacity]="currentPage === 1 ? '0.5' : '1'"
              [style.cursor]="currentPage === 1 ? 'not-allowed' : 'pointer'">
        ‚Äπ Tr∆∞·ªõc
      </button>

      <button *ngFor="let page of getPageNumbers()"
              (click)="goToPage(page)"
              [style.background-color]="page === currentPage ? '#2196F3' : '#f0f0f0'"
              [style.color]="page === currentPage ? 'white' : '#333'"
              [style.font-weight]="page === currentPage ? 'bold' : 'normal'"
              style="padding: 8px 12px; border: none; cursor: pointer; border-radius: 4px; min-width: 40px;">
        {{ page }}
      </button>

      <button (click)="nextPage()"
              [disabled]="currentPage === totalPages"
              style="padding: 8px 12px; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px;"
              [style.opacity]="currentPage === totalPages ? '0.5' : '1'"
              [style.cursor]="currentPage === totalPages ? 'not-allowed' : 'pointer'">
        Sau ‚Ä∫
      </button>
    </div>
  </div>
</div>

<!-- Empty state -->
<div *ngIf="selectedClass && selectedSemester && studentGrades.length === 0 && !loading" style="margin-top: 20px; padding: 20px; background-color: #f9f9f9; text-align: center;">
  <p>Kh√¥ng c√≥ h·ªçc sinh n√†o trong l·ªõp n√†y.</p>
</div>

<div *ngIf="selectedClass && selectedSemester && gradeTypes.length === 0 && !loading" style="margin-top: 20px; padding: 20px; background-color: #fff3cd; border: 1px solid #ffc107; text-align: center;">
  <p style="color: #856404; margin: 0;"><strong>Ch∆∞a c√≥ lo·∫°i ƒëi·ªÉm n√†o trong h·ªá th·ªëng!</strong></p>
  <p style="color: #856404; margin: 5px 0 0 0;">Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ th√™m c√°c lo·∫°i ƒëi·ªÉm (Th∆∞·ªùng xuy√™n, Gi·ªØa k·ª≥, Cu·ªëi k·ª≥, v.v.)</p>
</div>

<div *ngIf="!selectedClass || !selectedSemester" style="margin-top: 20px; padding: 20px; background-color: #f9f9f9; text-align: center;">
  <p>Vui l√≤ng ch·ªçn l·ªõp, m√¥n h·ªçc v√† h·ªçc k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠p ƒëi·ªÉm.</p>
</div>

<!-- Import Dialog -->
<div *ngIf="showImportDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
  <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
    <h3 style="margin-top: 0;">Import ƒêi·ªÉm t·ª´ Excel</h3>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: bold;">
        Lo·∫°i ƒëi·ªÉm:
      </label>
      <div style="display: flex; gap: 15px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio"
                 [(ngModel)]="importScoreType"
                 value="score"
                 name="scoreType"
                 style="margin-right: 5px;">
          ƒêi·ªÉm s·ªë (0-10)
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio"
                 [(ngModel)]="importScoreType"
                 value="comment"
                 name="scoreType"
                 style="margin-right: 5px;">
          Nh·∫≠n x√©t (Pass/Fail)
        </label>
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">
        Ch·ªçn file Excel:
      </label>
      <input type="file"
             accept=".xlsx,.xls"
             (change)="onFileSelected($event)"
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <small style="color: #666; display: block; margin-top: 5px;">
        File Excel ph·∫£i c√≥ c·ªôt: M√£ HS, Lo·∫°i ƒêi·ªÉm (ID), ƒêi·ªÉm/Nh·∫≠n x√©t
      </small>
    </div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button (click)="closeImportDialog()"
              style="padding: 10px 20px; background-color: #999; color: white; border: none; cursor: pointer; border-radius: 4px;">
        H·ªßy
      </button>
      <button (click)="importGrades()"
              [disabled]="!importFile"
              style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px;"
              [style.opacity]="!importFile ? '0.5' : '1'">
        Import
      </button>
    </div>
  </div>
</div>

<!-- Export Dialog -->
<div *ngIf="showExportDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
  <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
    <h3 style="margin-top: 0;">Export B·∫£ng ƒêi·ªÉm</h3>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: bold;">
        Ch·ªçn ƒë·ªãnh d·∫°ng file:
      </label>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="radio"
                 [(ngModel)]="exportFormat"
                 value="excel"
                 name="exportFormat"
                 style="margin-right: 10px;">
          <span style="font-size: 20px; margin-right: 10px;">üìä</span>
          <span>Excel (.xlsx)</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="radio"
                 [(ngModel)]="exportFormat"
                 value="word"
                 name="exportFormat"
                 style="margin-right: 10px;">
          <span style="font-size: 20px; margin-right: 10px;">üìÑ</span>
          <span>Word (.docx)</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="radio"
                 [(ngModel)]="exportFormat"
                 value="pdf"
                 name="exportFormat"
                 style="margin-right: 10px;">
          <span style="font-size: 20px; margin-right: 10px;">üìï</span>
          <span>PDF (.pdf)</span>
        </label>
      </div>
    </div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button (click)="closeExportDialog()"
              style="padding: 10px 20px; background-color: #999; color: white; border: none; cursor: pointer; border-radius: 4px;">
        H·ªßy
      </button>
      <button (click)="exportGrades()"
              [disabled]="!exportFormat"
              style="padding: 10px 20px; background-color: #FF9800; color: white; border: none; cursor: pointer; border-radius: 4px;"
              [style.opacity]="!exportFormat ? '0.5' : '1'">
        Export
      </button>
    </div>
  </div>
</div>
